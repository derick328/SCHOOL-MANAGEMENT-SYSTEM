<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - School Management System</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üéì SMS Teacher</h2>
                <p>Teacher Portal</p>
            </div>
            
            <nav class="sidebar-menu">
                <a href="#" class="menu-item active" onclick="showSection('dashboard')">
                    <span>üìä</span> Dashboard
                </a>
                <a href="#" class="menu-item" onclick="showSection('classes')">
                    <span>üè´</span> My Classes
                </a>
                <a href="#" class="menu-item" onclick="showSection('students')">
                    <span>üë®‚Äçüéì</span> Students
                </a>
                <a href="#" class="menu-item" onclick="showSection('attendance')">
                    <span>üìã</span> Attendance
                </a>
                <a href="#" class="menu-item" onclick="showSection('grades')">
                    <span>üìù</span> Grades & Marks
                </a>
                <a href="#" class="menu-item" onclick="showSection('schedule')">
                    <span>üìÖ</span> Schedule
                </a>
                <a href="#" class="menu-item" onclick="showSection('subjects')">
                    <span>üìö</span> Subjects
                </a>
                <a href="#" class="menu-item" onclick="showSection('assignments')">
                    <span>üìÑ</span> Assignments
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button onclick="handleLogout()" class="btn btn-danger" style="width: 100%;">
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="topbar">
                <div class="topbar-left">
                    <h3 id="pageTitle">Teacher Dashboard</h3>
                </div>
                <div class="topbar-right">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">TD</div>
                        <div>
                            <div style="font-weight: 600; font-size: 14px;" id="userName">Teacher Demo</div>
                            <div style="font-size: 12px; color: var(--secondary);">Teacher</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content">
                <!-- Dashboard Section -->
                <div id="dashboardSection">
                    <div class="card-grid">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">My Classes</span>
                                <div class="card-icon icon-primary">üè´</div>
                            </div>
                            <div class="card-value">0</div>
                            <div class="card-label">Classes assigned</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Total Students</span>
                                <div class="card-icon icon-success">üë®‚Äçüéì</div>
                            </div>
                            <div class="card-value">0</div>
                            <div class="card-label">Students teaching</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Pending Grades</span>
                                <div class="card-icon icon-warning">üìù</div>
                            </div>
                            <div class="card-value">0</div>
                            <div class="card-label">Assignments to grade</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Attendance Rate</span>
                                <div class="card-icon icon-info">üìä</div>
                            </div>
                            <div class="card-value">0%</div>
                            <div class="card-label">Overall attendance</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <h3>Today's Schedule</h3>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Class</th>
                                    <th>Subject</th>
                                    <th>Room</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px; color: var(--secondary);">
                                        No classes scheduled for today
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- My Classes Section -->
                <div id="classesSection" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>My Classes</h3>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Class Name</th>
                                    <th>Subject</th>
                                    <th>Students</th>
                                    <th>Schedule</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px; color: var(--secondary);">
                                        No classes assigned yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Students Section -->
                <div id="studentsSection" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>My Students</h3>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="studentSearch" placeholder="Search students..." style="padding: 8px; border: 2px solid var(--border); border-radius: 8px;">
                                <select id="classFilter" style="padding: 8px; border: 2px solid var(--border); border-radius: 8px;">
                                    <option value="">All Classes</option>
                                </select>
                                <button class="btn btn-primary btn-sm" onclick="loadStudents()">Search</button>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Admission No</th>
                                    <th>Name</th>
                                    <th>Class</th>
                                    <th>Section</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: var(--secondary);">
                                        Loading students...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Attendance Section -->
                <div id="attendanceSection" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Mark Attendance</h3>
                            <div>
                                <input type="date" id="attendanceDate" style="padding: 8px; border: 2px solid var(--border); border-radius: 8px; margin-right: 10px;">
                                <button class="btn btn-primary btn-sm" onclick="loadAttendance()">
                                    Load Class
                                </button>
                            </div>
                        </div>
                        <p style="color: var(--secondary); padding: 20px;">Select a date and class to mark attendance</p>
                    </div>
                </div>

                <!-- Grades Section -->
                <div id="gradesSection" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Enter Grades & Marks</h3>
                        </div>
                        <p style="color: var(--secondary); padding: 20px;">Grading module coming soon...</p>
                    </div>
                </div>

                <!-- Schedule Section -->
                <div id="scheduleSection" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Weekly Timetable</h3>
                            <button class="btn btn-primary btn-sm" onclick="showCreateTimetableForm()" id="createTimetableBtn">
                                + Create Timetable
                            </button>
                        </div>
                        
                        <!-- Create Timetable Form -->
                        <div id="timetableForm" style="display: none; background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px;">Create New Timetable Entry</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div>
                                    <label>Class Name *</label>
                                    <input type="text" id="ttClassName" class="form-input" placeholder="e.g., Grade 10" required>
                                </div>
                                <div>
                                    <label>Section</label>
                                    <input type="text" id="ttSection" class="form-input" placeholder="e.g., A">
                                </div>
                                <div>
                                    <label>Subject *</label>
                                    <input type="text" id="ttSubject" class="form-input" placeholder="e.g., Mathematics" required>
                                </div>
                                <div>
                                    <label>Teacher ID *</label>
                                    <input type="number" id="ttTeacherId" class="form-input" placeholder="Teacher ID" required>
                                </div>
                                <div>
                                    <label>Day of Week *</label>
                                    <select id="ttDayOfWeek" class="form-input" required>
                                        <option value="">Select Day</option>
                                        <option value="MONDAY">Monday</option>
                                        <option value="TUESDAY">Tuesday</option>
                                        <option value="WEDNESDAY">Wednesday</option>
                                        <option value="THURSDAY">Thursday</option>
                                        <option value="FRIDAY">Friday</option>
                                        <option value="SATURDAY">Saturday</option>
                                        <option value="SUNDAY">Sunday</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Room</label>
                                    <input type="text" id="ttRoom" class="form-input" placeholder="e.g., Room 101">
                                </div>
                                <div>
                                    <label>Start Time *</label>
                                    <input type="time" id="ttStartTime" class="form-input" required>
                                </div>
                                <div>
                                    <label>End Time *</label>
                                    <input type="time" id="ttEndTime" class="form-input" required>
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <label>Notes</label>
                                <textarea id="ttNotes" class="form-input" rows="2" placeholder="Additional notes"></textarea>
                            </div>
                            <div id="conflictAlert" style="display: none; margin-top: 15px; padding: 15px; background: #fee; border: 1px solid #fcc; border-radius: 8px; color: #c00;">
                            </div>
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="checkAndSaveTimetable()">Check Conflicts & Save</button>
                                <button class="btn btn-secondary" onclick="hideCreateTimetableForm()">Cancel</button>
                            </div>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Time</th>
                                    <th>Class</th>
                                    <th>Subject</th>
                                    <th>Teacher</th>
                                    <th>Room</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="timetableTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: var(--secondary);">
                                        Loading timetable...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Assignments Section -->
                <div id="assignmentsSection" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Assignments</h3>
                            <button class="btn btn-primary btn-sm" onclick="createAssignment()">
                                + Create Assignment
                            </button>
                        </div>
                        <p style="color: var(--secondary); padding: 20px;">Assignments module coming soon...</p>
                    </div>
                </div>

                <!-- Subjects Section -->
                <div id="subjectsSection" style="display: none;">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Subjects & Teachers</h3>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="subjectSearch" placeholder="Search subjects..." style="padding: 8px; border: 2px solid var(--border); border-radius: 8px;">
                                <button class="btn btn-primary btn-sm" onclick="loadSubjects()">Search</button>
                            </div>
                        </div>
                        <div id="subjectsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px;">
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--secondary);">
                                Loading subjects...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/app.js"></script>
    <script>
        let currentUser = null;
        let allStudents = [];
        let allTimetables = [];

        async function init() {
            await initDashboard();
            currentUser = Auth.getUser();
            
            // Check if user is academic teacher and show/hide create button
            if (currentUser && (currentUser.role === 'ACADEMIC_TEACHER' || currentUser.role === 'ADMIN' || currentUser.role === 'PRINCIPAL')) {
                document.getElementById('createTimetableBtn').style.display = 'block';
            } else {
                document.getElementById('createTimetableBtn').style.display = 'none';
            }
        }

        init();

        function showSection(section) {
            document.querySelectorAll('[id$="Section"]').forEach(el => el.style.display = 'none');
            document.getElementById(section + 'Section').style.display = 'block';
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.target.closest('.menu-item').classList.add('active');
            
            const titles = {
                dashboard: 'Teacher Dashboard',
                classes: 'My Classes',
                students: 'My Students',
                attendance: 'Mark Attendance',
                grades: 'Grades & Marks',
                schedule: 'Weekly Schedule',
                subjects: 'Subjects & Teachers',
                assignments: 'Assignments'
            };
            document.getElementById('pageTitle').textContent = titles[section];

            // Load data when switching sections
            if (section === 'students') {
                loadStudents();
            } else if (section === 'schedule') {
                loadTimetable();
            } else if (section === 'subjects') {
                loadSubjects();
            }
        }

        // ============ STUDENTS SECTION ============
        async function loadStudents() {
            const searchTerm = document.getElementById('studentSearch').value;
            const classFilter = document.getElementById('classFilter').value;
            const tbody = document.getElementById('studentsTableBody');
            
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Loading...</td></tr>';

            try {
                let url = '/teacher/students?';
                if (searchTerm) url += `search=${encodeURIComponent(searchTerm)}&`;
                if (classFilter) url += `className=${encodeURIComponent(classFilter)}`;

                const response = await API.request(url);
                
                if (response.success && response.data) {
                    allStudents = response.data;
                    displayStudents(allStudents);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No students found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading students:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--danger);">Error loading students</td></tr>';
            }
        }

        function displayStudents(students) {
            const tbody = document.getElementById('studentsTableBody');
            
            if (!students || students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No students found</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(student => `
                <tr>
                    <td>${student.admissionNumber || 'N/A'}</td>
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${student.currentClass || 'N/A'}</td>
                    <td>${student.section || 'N/A'}</td>
                    <td><span class="badge badge-${student.status === 'ACTIVE' ? 'success' : 'secondary'}">${student.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewStudentResults(${student.id})">View Results</button>
                    </td>
                </tr>
            `).join('');
        }

        async function viewStudentResults(studentId) {
            try {
                const response = await API.request(`/results/student/${studentId}`);
                
                if (response.success && response.data) {
                    const results = response.data;
                    const student = allStudents.find(s => s.id === studentId);
                    
                    if (results.length === 0) {
                        alert(`No results found for ${student.firstName} ${student.lastName}`);
                        return;
                    }

                    // Create results modal/display
                    let resultsHTML = `
                        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;" onclick="this.remove()">
                            <div style="background: white; padding: 30px; border-radius: 12px; max-width: 800px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                                <h3>${student.firstName} ${student.lastName} - Academic Results</h3>
                                <p style="color: var(--secondary);">Admission No: ${student.admissionNumber}</p>
                                <table style="width: 100%; margin-top: 20px;">
                                    <thead>
                                        <tr>
                                            <th>Subject</th>
                                            <th>Exam Type</th>
                                            <th>Year/Term</th>
                                            <th>Marks</th>
                                            <th>Grade</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${results.map(r => `
                                            <tr>
                                                <td>${r.subject}</td>
                                                <td>${r.examType}</td>
                                                <td>${r.academicYear} ${r.term ? '- ' + r.term : ''}</td>
                                                <td>${r.marksObtained}/${r.totalMarks}</td>
                                                <td><span class="badge badge-primary">${r.grade}</span></td>
                                                <td>${r.percentage.toFixed(1)}%</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <button class="btn btn-secondary" style="margin-top: 20px;" onclick="this.closest('div[style*=fixed]').remove()">Close</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', resultsHTML);
                }
            } catch (error) {
                console.error('Error loading results:', error);
                alert('Error loading student results');
            }
        }

        // ============ TIMETABLE SECTION ============
        async function loadTimetable() {
            const tbody = document.getElementById('timetableTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Loading...</td></tr>';

            try {
                const response = await API.request('/timetable');
                
                if (response.success && response.data) {
                    allTimetables = response.data;
                    displayTimetable(allTimetables);
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No timetable entries found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading timetable:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--danger);">Error loading timetable</td></tr>';
            }
        }

        function displayTimetable(timetables) {
            const tbody = document.getElementById('timetableTableBody');
            
            if (!timetables || timetables.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No timetable entries</td></tr>';
                return;
            }

            // Sort by day and time
            const dayOrder = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY', 'SUNDAY'];
            timetables.sort((a, b) => {
                const dayDiff = dayOrder.indexOf(a.dayOfWeek) - dayOrder.indexOf(b.dayOfWeek);
                if (dayDiff !== 0) return dayDiff;
                return a.startTime.localeCompare(b.startTime);
            });

            tbody.innerHTML = timetables.map(tt => `
                <tr>
                    <td>${tt.dayOfWeek}</td>
                    <td>${tt.startTime} - ${tt.endTime}</td>
                    <td>${tt.className}${tt.section ? ' - ' + tt.section : ''}</td>
                    <td>${tt.subject}</td>
                    <td>${tt.teacherName}</td>
                    <td>${tt.room || 'N/A'}</td>
                    <td>
                        ${currentUser && (currentUser.role === 'ACADEMIC_TEACHER' || currentUser.role === 'ADMIN' || currentUser.role === 'PRINCIPAL') ? 
                            `<button class="btn btn-sm btn-danger" onclick="deleteTimetable(${tt.id})">Delete</button>` : 
                            'View Only'}
                    </td>
                </tr>
            `).join('');
        }

        function showCreateTimetableForm() {
            document.getElementById('timetableForm').style.display = 'block';
            document.getElementById('conflictAlert').style.display = 'none';
        }

        function hideCreateTimetableForm() {
            document.getElementById('timetableForm').style.display = 'none';
            document.getElementById('ttClassName').value = '';
            document.getElementById('ttSection').value = '';
            document.getElementById('ttSubject').value = '';
            document.getElementById('ttTeacherId').value = '';
            document.getElementById('ttDayOfWeek').value = '';
            document.getElementById('ttRoom').value = '';
            document.getElementById('ttStartTime').value = '';
            document.getElementById('ttEndTime').value = '';
            document.getElementById('ttNotes').value = '';
            document.getElementById('conflictAlert').style.display = 'none';
        }

        async function checkAndSaveTimetable() {
            const request = {
                className: document.getElementById('ttClassName').value,
                section: document.getElementById('ttSection').value || null,
                subject: document.getElementById('ttSubject').value,
                teacherId: parseInt(document.getElementById('ttTeacherId').value),
                dayOfWeek: document.getElementById('ttDayOfWeek').value,
                startTime: document.getElementById('ttStartTime').value,
                endTime: document.getElementById('ttEndTime').value,
                room: document.getElementById('ttRoom').value || null,
                notes: document.getElementById('ttNotes').value || null,
                isActive: true
            };

            // Validate required fields
            if (!request.className || !request.subject || !request.teacherId || !request.dayOfWeek || !request.startTime || !request.endTime) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                // Check for conflicts
                const conflictResponse = await API.request('/timetable/check-conflicts', {
                    method: 'POST',
                    body: JSON.stringify(request)
                });

                if (conflictResponse.success && conflictResponse.data) {
                    const conflictData = conflictResponse.data;
                    
                    if (conflictData.hasConflict) {
                        // Show conflicts
                        const conflictAlert = document.getElementById('conflictAlert');
                        conflictAlert.style.display = 'block';
                        conflictAlert.innerHTML = `
                            <strong>‚ö†Ô∏è Conflicts Detected:</strong><br>
                            ${conflictData.conflicts.map(c => `‚Ä¢ ${c.type}: ${c.description}`).join('<br>')}
                            <br><br>Please adjust the schedule to resolve conflicts.
                        `;
                        return;
                    }
                }

                // No conflicts, save timetable
                const response = await API.request('/timetable', {
                    method: 'POST',
                    body: JSON.stringify(request)
                });

                if (response.success) {
                    UI.showAlert('Timetable created successfully!', 'success');
                    hideCreateTimetableForm();
                    loadTimetable();
                } else {
                    alert('Error creating timetable: ' + response.message);
                }
            } catch (error) {
                console.error('Error creating timetable:', error);
                alert('Error creating timetable: ' + error.message);
            }
        }

        async function deleteTimetable(id) {
            if (!confirm('Are you sure you want to delete this timetable entry?')) {
                return;
            }

            try {
                const response = await API.request(`/timetable/${id}`, {
                    method: 'DELETE'
                });

                if (response.success) {
                    UI.showAlert('Timetable deleted successfully', 'success');
                    loadTimetable();
                } else {
                    alert('Error deleting timetable');
                }
            } catch (error) {
                console.error('Error deleting timetable:', error);
                alert('Error deleting timetable');
            }
        }

        function loadAttendance() {
            UI.showAlert('Attendance marking will be implemented with backend API', 'info');
        }

        function createAssignment() {
            UI.showAlert('Assignment creation will be implemented with backend API', 'info');
        }

        // ============ SUBJECTS SECTION ============
        async function loadSubjects() {
            const searchTerm = document.getElementById('subjectSearch').value;
            const container = document.getElementById('subjectsContainer');
            
            container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;">Loading subjects...</div>';

            try {
                // Fetch all teachers
                const response = await API.request('/teacher/students');
                
                if (!response.success || !response.data) {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--secondary);">No data available</div>';
                    return;
                }

                // Extract unique subjects from teachers
                const subjectsMap = new Map();
                
                // For now, we'll use the teacher data we have
                // In a real scenario, you'd have a dedicated endpoint to fetch teachers with subjects
                const teachersResponse = await fetch(`${API.BASE_URL}/admin/teachers`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (teachersResponse.ok) {
                    const teachersData = await teachersResponse.json();
                    const teachers = teachersData.data || [];
                    
                    // Group teachers by subject
                    teachers.forEach(teacher => {
                        if (teacher.subjects) {
                            const subjects = teacher.subjects.split(',').map(s => s.trim());
                            subjects.forEach(subject => {
                                if (subject && (!searchTerm || subject.toLowerCase().includes(searchTerm.toLowerCase()))) {
                                    if (!subjectsMap.has(subject)) {
                                        subjectsMap.set(subject, []);
                                    }
                                    subjectsMap.get(subject).push(teacher);
                                }
                            });
                        }
                    });

                    if (subjectsMap.size === 0) {
                        container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--secondary);">No subjects found</div>';
                        return;
                    }

                    // Sort subjects alphabetically
                    const sortedSubjects = Array.from(subjectsMap.keys()).sort();
                    
                    // Display subjects with teachers
                    container.innerHTML = sortedSubjects.map(subject => {
                        const teachers = subjectsMap.get(subject);
                        return `
                            <div class="card" style="padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                    <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); 
                                                width: 48px; height: 48px; border-radius: 12px; display: flex; 
                                                align-items: center; justify-content: center; font-size: 24px;">
                                        üìö
                                    </div>
                                    <div>
                                        <h3 style="margin: 0; font-size: 18px; color: var(--text);">${subject}</h3>
                                        <p style="margin: 0; font-size: 13px; color: var(--secondary);">
                                            ${teachers.length} teacher${teachers.length !== 1 ? 's' : ''}
                                        </p>
                                    </div>
                                </div>
                                <div style="border-top: 1px solid var(--border); padding-top: 15px;">
                                    ${teachers.map(teacher => `
                                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; 
                                                    background: var(--background); border-radius: 8px; margin-bottom: 8px;">
                                            <div style="width: 36px; height: 36px; border-radius: 50%; 
                                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                                        display: flex; align-items: center; justify-content: center; 
                                                        color: white; font-weight: 600; font-size: 14px;">
                                                ${teacher.firstName?.charAt(0) || 'T'}${teacher.lastName?.charAt(0) || ''}
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; font-size: 14px; color: var(--text);">
                                                    ${teacher.firstName || ''} ${teacher.lastName || ''}
                                                </div>
                                                <div style="font-size: 12px; color: var(--secondary);">
                                                    ${teacher.email || 'No email'}
                                                </div>
                                            </div>
                                            <span class="badge badge-primary" style="font-size: 11px;">
                                                ${teacher.experienceYears || 0} yrs
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--danger);">Error loading teachers data</div>';
                }
            } catch (error) {
                console.error('Error loading subjects:', error);
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--danger);">Error loading subjects</div>';
            }
        }
    </script>
    <style>
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        .badge-secondary {
            background: #e2e3e5;
            color: #383d41;
        }
        .badge-primary {
            background: #cfe2ff;
            color: #084298;
        }
    </style>
</body>
</html>
